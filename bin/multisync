#!/usr/bin/env ruby

require 'multisync'

require 'optparse'
require 'text/highlight'
String.highlighter = Text::ANSIHighlighter.new

def stats_to_report
  [ 'Number of files',
    'Number of created files',
    'Number of deleted files',
    'Number of regular files transferred',
    'Total file size',
    'Total transferred file size', ]
end

CATALOG_FILE = 'catalog.rb'

options = { list: false, dryrun: false }
parser = OptionParser.new do |o|
  o.banner = "\nRun rsync jobs defined in the catalog file '#{CATALOG_FILE}'.\n\n"+
             "Usage: #$0 [options] [SET] [...]\n"
                
  o.separator ''
  o.on('-l', '--list', "List the catalog") do
    options[:list] = true
  end
  o.on('-n', '--dryrun', "Do not make any changes.") do |n|
    options[:dryrun] = n
  end
  o.separator ''
end
parser.parse!

catalog = Multisync::Catalog.load CATALOG_FILE
if options[:list]
  puts
  catalog.list
  puts
  exit
end

sets = ARGV.empty? ? %w( root ) : ARGV
syncs = catalog.run Multisync::Runtime.new(options), sets

puts
exit if options[:dryrun]

puts '_' * 80
syncs.each do |sync|
  puts
  if sync.result.success?
    puts sync.description.bold.green
    puts stdout.scan(/(?:#{stats_to_report.join('|')}):.*/)
  else
    puts "#{sync.description} (failed #{sync.result.status.exitstatus})".bold.red
    puts sync.result.stderr
  end
end
puts
